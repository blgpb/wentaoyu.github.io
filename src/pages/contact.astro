---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getSiteSettings } from '../lib/site';

const site = await getSiteSettings();
const formEndpoint = 'https://api.web3forms.com/submit';
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY ?? 'df5f3046-14dd-40ab-9175-de36d81343a3';
---

<BaseLayout title="Contact" description="Email, office, and secure contact form." section="Contact">
  <section class="section contact">
    <div class="surface contact__card">
      <h1>Get in touch</h1>
      <p>Collaborations, mentoring, media requests, and visiting appointments are welcome.</p>
      <dl>
        <div>
          <dt>Email</dt>
          <dd data-email="{site.contact.email}"><span>{site.contact.email}</span></dd>
        </div>
        <div>
          <dt>Office</dt>
          <dd>{site.contact.office}</dd>
        </div>
        <div>
          <dt>Address</dt>
          <dd>{site.contact.address}</dd>
        </div>
        {site.contact.officeHours && (
          <div>
            <dt>Office hours</dt>
            <dd>{site.contact.officeHours}</dd>
          </div>
        )}
      </dl>
      <div class="social-links">
        <a href={site.social.scholar}>Scholar</a>
        <a href={site.social.github}>GitHub</a>
        <a href={site.social.linkedin}>LinkedIn</a>
        <a href={site.social.orcid}>ORCID</a>
        {site.social.twitter && <a href={site.social.twitter}>Twitter/X</a>}
      </div>
      <figure class="wechat-qr">
        <img src="/wechat.png" alt="Scan to add Alex Chen on WeChat" loading="lazy" />
        <figcaption>Scan the QR code to contact me on WeChat. Welcome to discuss!</figcaption>
      </figure>
    </div>

    <form class="surface contact__form" action={formEndpoint} method="POST" data-enhanced>
      <h2>Send a message</h2>
      <p>This form is powered by Web3Forms, includes a honeypot for spam prevention.</p>
      <input type="hidden" name="access_key" value={accessKey} />
      <label>
        Name
        <input type="text" name="name" required autocomplete="name" />
      </label>
      <label>
        Email
        <input type="email" name="email" required autocomplete="email" />
      </label>
      <label>
        Message
        <textarea name="message" required rows="5"></textarea>
      </label>
      <label class="honeypot" aria-hidden="true">
        Leave this field blank
        <input type="text" name="company" tabindex="-1" autocomplete="off" />
      </label>
      <button class="button-primary" type="submit">Send securely</button>
      {!accessKey && <p class="note">Provide `PUBLIC_WEB3FORMS_ACCESS_KEY` to enable submissions.</p>}
    </form>
  </section>
</BaseLayout>

<script is:inline>
  const emailNode = document.querySelector('[data-email] span');
  if (emailNode) {
    emailNode.textContent = emailNode.textContent?.replace('[at]', '@').replace(/\s+/g, '');
  }
</script>

<style>
  .contact {
    display: grid;
    gap: 2rem;
  }
  dl {
    margin: 1.5rem 0;
  }
  dt {
    font-size: 0.85rem;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }
  dd {
    margin: 0 0 1rem;
    font-size: 1rem;
  }
  .contact__form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .honeypot {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  .social-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .wechat-qr {
    margin: 2rem 0 0;
    text-align: center;
  }
  .wechat-qr img {
    width: min(220px, 80%);
    border-radius: 1rem;
    border: 1px solid var(--border);
    background: var(--surface-muted);
    padding: 0.5rem;
    box-shadow: var(--shadow);
    display: block;
    margin: 0 auto;
  }
  .wechat-qr figcaption {
    margin-top: 0.75rem;
    font-size: 0.95rem;
    color: var(--text-muted);
  }
  @media (min-width: 900px) {
    .contact {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>
